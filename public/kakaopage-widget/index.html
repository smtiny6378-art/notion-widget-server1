<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KakaoPage â†’ Notion</title>
  <style>
    :root{
      --kp-yellow:#FFE400;
      --kp-yellow-soft: rgba(255, 228, 0, .10);

      --text:#111;
      --muted: rgba(0,0,0,.55);
      --line: rgba(0,0,0,.10);
      --line2: rgba(0,0,0,.16);

      --card: #ffffff;
      --bg: #efefef;

      --ok:#0a7a2f;
      --err:#b00020;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      padding: 20px;
    }

    .frame{
      width:100%;
      max-width: 980px;
      margin: 0 auto;
      padding: 14px;
      border-radius: 22px;
      border: 2px solid rgba(255, 228, 0, .95);
      background: var(--kp-yellow-soft);
    }

    .grid{
      display:grid;
      grid-template-columns: 300px 1fr;
      gap: 8px;
    }

    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
    }

    .panel{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      overflow:hidden;
    }

    /* LEFT */
    .left{
      display:flex;
      flex-direction:column;
      height: 100%;
      min-height: 360px;
    }

    .leftTop{
      padding: 18px 18px 12px;
      display:flex;
      gap: 14px;
      align-items:center;
    }

    .kpIcon{
      width: 64px;
      height: 64px;
      border-radius: 22px;
      background: var(--kp-yellow);
      border: 1px solid rgba(0,0,0,.12);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
    }

    .kpIcon svg{ width: 30px; height: 30px; }

    .leftTitle{
      font-weight: 900;
      font-size: 17px;
      line-height: 1.25;
      letter-spacing: -0.2px;
    }

    .leftSub{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .divider{
      height:1px;
      background: rgba(0,0,0,.06);
      margin: 6px 18px 0;
    }

    .leftBottom{
      margin-top: auto;
      padding: 18px;
    }

    .saveBig{
      width:100%;
      cursor:pointer;
      border: none;
      background: var(--kp-yellow);
      color:#111;
      font-weight: 900;
      font-size: 15px;
      border-radius: 14px;
      padding: 16px 14px;
      text-align:center;
      user-select:none;
      box-shadow: 0 2px 0 rgba(0,0,0,.06);
    }

    .saveBig:hover{ filter: brightness(0.98); }
    .saveBig:disabled{ opacity:.6; cursor:not-allowed; }

    /* RIGHT */
    .right{
      padding: 16px 16px 14px;
      min-height: 360px;
      display:flex;
      flex-direction:column;
    }

    .rightHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .rightTitle{
      font-weight: 900;
      font-size: 14px;
      letter-spacing: -0.2px;
      white-space: nowrap;
    }

    .rightActions{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .miniBtn{
      all:unset;
      cursor:pointer;
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid var(--line2);
      background: #f3f3f3;
      font-size: 12px;
      font-weight: 800;
      user-select:none;
    }

    .miniBtn:hover{ background: #ededed; }
    .miniBtn:disabled{ opacity:.55; cursor:not-allowed; }

    textarea{
      width:100%;
      min-height: 210px;
      flex: 1 1 auto;
      resize: vertical;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: #fafafa;
      font-size: 13px;
      color: var(--text);
      outline: none;
    }
    textarea::placeholder{ color: rgba(0,0,0,.35); }

    .toast{
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: #f3f3f3;
      color: var(--muted);
      font-size: 12px;
      min-height: 40px;
      display:flex;
      align-items:center;
      white-space: pre-wrap;
    }
    .ok{ color: var(--ok); }
    .err{ color: var(--err); }

    .log{
      margin-top: 8px;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 0 12px;
      background: #f7f7f7;
      font-size: 12px;
      line-height: 1.45;

      flex: 0 0 auto;
      min-height: 0;
      max-height: 0;
      overflow: hidden;
      white-space: pre-wrap;

      transition: max-height .22s ease, padding .18s ease, opacity .18s ease;
      opacity: 0;
    }

    .log.open{
      max-height: 110px;
      padding: 10px 12px;
      overflow: auto;
      opacity: 1;
    }

    .log .muted{ color: var(--muted); }
  </style>
</head>

<body>
  <div class="frame">
    <div class="grid">

      <!-- LEFT PANEL -->
      <div class="panel left">
        <div class="leftTop">
          <div class="kpIcon" aria-label="KakaoPage">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M6 5.5V18.5" stroke="#111" stroke-width="2.2" stroke-linecap="round"/>
              <path d="M18 5.7L10.8 12L18 18.3" stroke="#111" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div style="min-width:0;">
            <div class="leftTitle">ì¹´ì¹´ì˜¤í˜ì´ì§€ URL</div>
            <div class="leftSub">ì˜¤ë¥¸ìª½ì— URL ë¶™ì—¬ë„£ê³  ì €ì¥í•˜ì„¸ìš”.</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="leftBottom">
          <button id="saveBig" class="saveBig">ë…¸ì…˜ì— ì €ì¥</button>
        </div>
      </div>

      <!-- RIGHT PANEL -->
      <div class="panel">
        <div class="right">
          <div class="rightHeader">
            <div class="rightTitle">ì¹´ì¹´ì˜¤í˜ì´ì§€ URL</div>
            <div class="rightActions">
              <button class="miniBtn" id="toggleLogBtn">ë¡œê·¸ ë³´ê¸°</button>
              <button class="miniBtn" id="openFirstBtn">ì²« URL ì—´ê¸°</button>
              <button class="miniBtn" id="clearBtn">ì…ë ¥ ì§€ìš°ê¸°</button>
            </div>
          </div>

          <textarea id="contentUrls" placeholder="ì—¬ê¸°ì— ì‘í’ˆ URLì„ ì¤„ë°”ê¿ˆìœ¼ë¡œ ì—¬ëŸ¬ ê°œ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”"></textarea>

          <div class="toast" id="toast">URLì„ ì…ë ¥í•˜ê³  ì™¼ìª½ â€œë…¸ì…˜ì— ì €ì¥â€ì„ ëˆŒëŸ¬ ë³´ì„¸ìš”.</div>
          <div class="log" id="log"><span class="muted">ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë¼ìš”.</span></div>
        </div>
      </div>

    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function setToast(text, cls=""){
      const el = $("toast");
      el.className = "toast " + cls;
      el.textContent = text || "";
    }

    function appendLog(line){
      const el = $("log");
      if (el.textContent.includes("ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë¼ìš”.")) el.textContent = "";
      el.textContent += (el.textContent ? "\n" : "") + line;
      el.scrollTop = el.scrollHeight;
    }

    function openInNewTab(url){
      window.open(url, "_blank", "noopener,noreferrer");
    }

    function parseTextarea(raw){
      return String(raw || "").split(/\r?\n/);
    }

    function normalizeUrls(raw){
      const lines = parseTextarea(raw);
      const trimmedNonEmpty = lines.map(s => s.trim()).filter(Boolean);

      const seen = new Set();
      const unique = [];
      for (const u of trimmedNonEmpty){
        if (seen.has(u)) continue;
        seen.add(u);
        unique.push(u);
      }

      const valid = [];
      const invalid = [];

      for (const u of unique){
        try {
          const parsed = new URL(u);
          if (!/page\.kakao\.com$/i.test(parsed.hostname)){
            invalid.push(u);
            continue;
          }
          valid.push(u);
        } catch {
          invalid.push(u);
        }
      }
      return { valid, invalid };
    }

    function removeSucceededFromTextarea(succeededSet){
      const lines = parseTextarea($("contentUrls").value);

      const kept = [];
      for (const line of lines){
        const t = line.trim();
        if (!t) { kept.push(line); continue; }
        if (succeededSet.has(t)) continue;
        kept.push(line);
      }

      const compact = [];
      let emptyRun = 0;
      for (const line of kept){
        if (!line.trim()){
          emptyRun++;
          if (emptyRun <= 2) compact.push("");
        } else {
          emptyRun = 0;
          compact.push(line.trim());
        }
      }
      while (compact.length && !compact[0].trim()) compact.shift();
      while (compact.length && !compact[compact.length-1].trim()) compact.pop();

      $("contentUrls").value = compact.join("\n");
    }

    async function postJson(path, payload){
      const r = await fetch(path, {
        method: "POST",
        headers: { "content-type":"application/json" },
        body: JSON.stringify(payload)
      });
      const text = await r.text();
      let data;
      try { data = JSON.parse(text); }
      catch { data = { ok:false, error:"Non-JSON response", detail:text.slice(0,200) }; }
      return { status: r.status, data };
    }

    function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }

    function lockUI(locked){
      $("saveBig").disabled = locked;
      $("openFirstBtn").disabled = locked;
      $("clearBtn").disabled = locked;
      $("toggleLogBtn").disabled = locked;
    }

    const toggleLogBtn = $("toggleLogBtn");
    const logBox = $("log");

    toggleLogBtn.addEventListener("click", () => {
      const opened = logBox.classList.toggle("open");
      toggleLogBtn.textContent = opened ? "ë¡œê·¸ ìˆ¨ê¸°ê¸°" : "ë¡œê·¸ ë³´ê¸°";
    });

    function openLogIfClosed(){
      if (!logBox.classList.contains("open")){
        logBox.classList.add("open");
        toggleLogBtn.textContent = "ë¡œê·¸ ìˆ¨ê¸°ê¸°";
      }
    }

    $("openFirstBtn").addEventListener("click", () => {
      const { valid } = normalizeUrls($("contentUrls").value);
      if (!valid.length) return setToast("ë¨¼ì € URLì„ 1ê°œ ì´ìƒ ë„£ì–´ ì£¼ì„¸ìš”.", "err");
      openInNewTab(valid[0]);
      setToast("ì²« ë²ˆì§¸ URLì„ ìƒˆ íƒ­ìœ¼ë¡œ ì—´ì—ˆì–´ìš”.");
    });

    $("clearBtn").addEventListener("click", () => {
      $("contentUrls").value = "";
      $("log").textContent = "ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë¼ìš”.";
      setToast("ì…ë ¥ì„ ì§€ì› ì–´ìš”.");
    });

    async function runSave(){
      const raw = $("contentUrls").value;
      const { valid, invalid } = normalizeUrls(raw);

      if (!valid.length){
        return setToast("ì €ì¥í•  URLì´ ì—†ì–´ìš”. ì¤„ë°”ê¿ˆìœ¼ë¡œ URLì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.", "err");
      }

      lockUI(true);

      $("log").textContent = "";
      if (invalid.length){
        appendLog(`âš ï¸ ì œì™¸ëœ URL ${invalid.length}ê°œ:`);
        for (const u of invalid) appendLog(`  - ${u}`);
        appendLog("");
      }

      setToast(`ì €ì¥ ì‹œì‘: ${valid.length}ê°œ`, "");
      appendLog(`âœ… ì €ì¥ ì‹œì‘ (${valid.length}ê°œ)`);

      let okCount = 0;
      let failCount = 0;
      const succeeded = new Set();
      const GAP_MS = 250;

      for (let i = 0; i < valid.length; i++){
        const url = valid[i];
        setToast(`ì €ì¥ ì¤‘â€¦ (${i+1}/${valid.length})`, "");
        appendLog(`â³ (${i+1}/${valid.length}) ì €ì¥ ìš”ì²­: ${url}`);

        try {
          const res = await postJson("/api/notion-create", { platform: "ì¹´ì¹´ì˜¤í˜ì´ì§€", url });

          if (res.data && res.data.ok){
            okCount++;
            succeeded.add(url);
            const dbg = res.data.debug
              ? ` (upstream: ${res.data.debug.upstreamStatus}${res.data.debug.redirectedTo ? ", redirected" : ""})`
              : "";
            appendLog(`âœ… ì™„ë£Œ: ${url}${dbg}`);
          } else {
            failCount++;
            appendLog(`âŒ ì‹¤íŒ¨: ${url} â€” ${res.data?.error || "unknown"}`);
            openLogIfClosed();
          }
        } catch (e){
          failCount++;
          appendLog(`âŒ ì‹¤íŒ¨: ${url} â€” ${String(e?.message || e)}`);
          openLogIfClosed();
        }

        await sleep(GAP_MS);
      }

      if (succeeded.size){
        removeSucceededFromTextarea(succeeded);
        appendLog("");
        appendLog(`ğŸ§¹ ì…ë ¥ì°½ ì •ë¦¬: ì„±ê³µ ${succeeded.size}ê°œ URLì„ ì œê±°í–ˆì–´ìš”.`);
      }

      if (failCount === 0){
        setToast(`ì €ì¥ ì™„ë£Œ! ${okCount}/${valid.length}ê°œ ì„±ê³µ`, "ok");
      } else if (okCount === 0){
        setToast(`ì €ì¥ ì‹¤íŒ¨â€¦ ${failCount}/${valid.length}ê°œ ì‹¤íŒ¨`, "err");
      } else {
        setToast(`ì €ì¥ ì™„ë£Œ (ì„±ê³µ ${okCount}, ì‹¤íŒ¨ ${failCount})`, "err");
      }

      lockUI(false);
    }

    $("saveBig").addEventListener("click", runSave);

    $("contentUrls").addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter"){
        e.preventDefault();
        runSave();
      }
    });
  </script>
</body>
</html>
