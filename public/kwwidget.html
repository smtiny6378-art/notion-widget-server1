<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Kakao Webtoon Widget</title>
  <style>
    body { margin:0; font-family: system-ui, sans-serif; background:#111; color:#fff; }
    .card { padding:16px; border-radius:12px; background:#1c1c1c; width:380px; }
    input { width:100%; padding:10px; border-radius:8px; border:none; outline:none; margin-top:10px; }
    button { width:100%; padding:10px 12px; border-radius:8px; border:none; cursor:pointer; margin-top:8px; }
    .hint { font-size:12px; color:#aaa; margin-top:8px; line-height:1.45; }
    img { width:100%; border-radius:8px; margin-top:10px; }
    .badge { display:inline-block; background:#444; color:#ddd; padding:4px 8px; border-radius:999px; font-size:12px; margin:6px 0 0; }
    .error { margin-top:10px; background:#2a1515; color:#ffb4b4; padding:10px; border-radius:8px; font-size:12px; white-space:pre-wrap; }
    .loading { margin-top:10px; color:#bbb; font-size:12px; }
    a { color:#9ecbff; }
    .hr { height:1px; background:#2d2d2d; margin:12px 0; }
  </style>
</head>
<body>
  <div class="card">
    <div class="hint">
      입력칸에 <b>작품 URL</b> 또는 <b>제목</b>을 넣고 실행하세요.<br/>
      - URL → 상세 불러오기<br/>
      - 제목 → 카카오웹툰 검색 새 탭
    </div>

    <input id="input" placeholder="작품 URL 또는 제목 (예: 병아리반)" />
    <button id="go">실행</button>

    <div class="hr"></div>

    <div id="status" class="loading" style="display:none;"></div>
    <div id="error" class="error" style="display:none;"></div>
    <div id="detail"></div>

    <button id="saveBtn" style="display:none; background:#4c7cff; color:#fff;">
      노션에 저장
    </button>

    <div class="hint" style="margin-top:14px;">
      예시 URL 형식:<br/>
      https://webtoon.kakao.com/content/작품명/12345
    </div>
  </div>

  <script>
    const inputEl = document.getElementById("input");
    const goBtn = document.getElementById("go");
    const saveBtn = document.getElementById("saveBtn");
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");
    const detailEl = document.getElementById("detail");

    let currentData = null;

    function setLoading(msg) {
      statusEl.style.display = "block";
      statusEl.textContent = msg || "로딩 중...";
    }
    function clearLoading() {
      statusEl.style.display = "none";
      statusEl.textContent = "";
    }
    function showError(msg) {
      errorEl.style.display = "block";
      errorEl.textContent = msg;
    }
    function clearError() {
      errorEl.style.display = "none";
      errorEl.textContent = "";
    }

    function isProbablyUrl(s) {
      return /^https?:\/\/\S+/i.test(s);
    }

    function openKakaoSearch(keyword) {
      const url = "https://webtoon.kakao.com/search?keyword=" + encodeURIComponent(keyword);
      window.open(url, "_blank");
    }

    async function loadDetailByUrl(url) {
      clearError();
      detailEl.innerHTML = "";
      saveBtn.style.display = "none";
      setLoading("상세 불러오는 중...");

      try {
        const res = await fetch("/api/getKakaoDetail?url=" + encodeURIComponent(url));
        const d = await res.json();
        if (!d.ok) throw new Error(d.error || "getKakaoDetail failed");

        currentData = d;

        const genreText = Array.isArray(d.genre) && d.genre.length ? d.genre.join(", ") : "";
        const authorText = d.authorName || "";

        detailEl.innerHTML = `
          <h3 style="margin:0 0 8px;">${d.title || ""}</h3>

          ${d.isAdult ? `<div class="badge">19세 이용가</div>` : ``}

          ${d.cover ? `<img src="${d.cover}" />` : ""}

          <div class="hint">${d.platform || "카카오웹툰"}</div>

          ${authorText ? `<div class="hint">작가: ${authorText}</div>` : ""}
          ${genreText ? `<div class="hint">장르: ${genreText}</div>` : ""}

          <p style="font-size:13px; line-height:1.5; margin-top:8px; white-space:pre-wrap;">${d.desc || ""}</p>
          <div class="hint"><a href="${d.url}" target="_blank">카카오웹툰에서 열기</a></div>
        `;

        saveBtn.style.display = "block";
      } catch (e) {
        showError("상세 실패: " + (e?.message || e));
      } finally {
        clearLoading();
      }
    }

    async function run() {
      const v = (inputEl.value || "").trim();
      if (!v) return;

      if (isProbablyUrl(v)) {
        await loadDetailByUrl(v);
      } else {
        clearError();
        detailEl.innerHTML = `
          <div class="hint">
            새 탭에서 검색 결과를 열었어요.<br/>
            작품 페이지로 들어간 뒤 URL을 복사해서 붙여넣어 주세요.
          </div>
        `;
        openKakaoSearch(v);
      }
    }

    goBtn.addEventListener("click", run);
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") run();
    });

    saveBtn.addEventListener("click", async () => {
      if (!currentData) return;

      setLoading("노션에 저장 중...");
      try {
        const res = await fetch("/api/addToNotion", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            platform: "카카오웹툰",
            title: currentData.title,
            coverUrl: currentData.cover,
            url: currentData.url,
            desc: currentData.desc,
            isAdult: currentData.isAdult,

            // ✅ 자동 추출 값도 함께 저장
            authorName: currentData.authorName || "",
            genre: Array.isArray(currentData.genre) ? currentData.genre : [],
          }),
        });

        const r = await res.json();
        if (!r.ok) throw new Error(r.error || "addToNotion failed");

        alert("노션에 저장 완료!");
      } catch (e) {
        showError("노션 저장 실패: " + (e?.message || e));
      } finally {
        clearLoading();
      }
    });
  </script>
</body>
</html>
