<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RIDI → Notion 위젯</title>
  <style>
    :root{
      --ridi:#1f8ce6; --bg:#fff; --line:#e6e8ee; --text:#111827; --muted:#6b7280;
    }
    *{box-sizing:border-box}
    body{margin:0; padding:16px; background:transparent; font-family:system-ui,-apple-system,"Noto Sans KR","Apple SD Gothic Neo","Malgun Gothic",sans-serif; color:var(--text);}
    .ridi-frame{border:2px solid var(--ridi); border-radius:16px; padding:6px; background:transparent;}
    .ridi-frame-inner{border:1px solid var(--line); border-radius:12px; background:var(--bg); display:flex; gap:14px; padding:14px; align-items:center;}
    .cover{width:64px; height:64px; border-radius:12px; background:#f3f4f6; display:flex; align-items:center; justify-content:center; flex:0 0 auto;}
    .ridi-logo{display:flex; align-items:center; gap:8px; user-select:none;}
    .ridi-mark{width:26px; height:26px; border-radius:8px; background:var(--ridi); color:#fff; font-weight:800; font-size:14px; display:grid; place-items:center;}
    .ridi-word{color:var(--ridi); font-weight:900; letter-spacing:.02em; font-size:15px;}
    .info{flex:1 1 auto; min-width:0;}
    .title{font-size:16px; font-weight:800; margin:0 0 4px;}
    .meta{font-size:12px; color:var(--muted); margin:0 0 10px;}
    .search-wrap{position:relative; width:min(520px,100%);}
    .search{display:flex; align-items:center; gap:8px; background:#f7f7fb; border:1px solid var(--line); border-radius:999px; padding:8px 12px; width:100%;}
    .search-icon{color:#9aa3af; flex:0 0 auto;}
    #searchInput{border:0; outline:0; background:transparent; width:100%; font-size:13px;}
    .result-popover{position:absolute; left:0; right:0; top:calc(100% + 10px); background:#fff; border:1px solid var(--line); border-radius:14px;
      box-shadow:0 18px 44px rgba(17,24,39,.12); padding:10px; z-index:50; max-height:380px; overflow:auto; display:none;}
    .results{display:grid; gap:10px;}
    .result-item{display:flex; gap:10px; padding:10px; border:1px solid var(--line); border-radius:12px; cursor:pointer; transition:.05s; background:#fff;}
    .result-item:hover{transform:translateY(-1px); box-shadow:0 6px 16px rgba(17,24,39,.08);}
    .result-thumb{position:relative; width:46px; height:66px; border-radius:10px; overflow:hidden; background:#f3f4f6; flex:0 0 auto;}
    .result-thumb img{width:100%; height:100%; object-fit:cover; display:block;}
    .badge19{position:absolute; top:6px; right:6px; padding:2px 6px; border-radius:999px; background:rgba(0,0,0,.78); color:#fff; font-size:11px; font-weight:800;}
    .result-info{min-width:0; display:flex; flex-direction:column; justify-content:center;}
    .result-title{font-size:14px; font-weight:800; line-height:1.25; margin:0 0 4px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .empty-msg{color:var(--muted); font-size:13px; padding:6px 2px;}
  </style>
</head>
<body>
  <div class="ridi-frame">
    <div class="ridi-frame-inner">
      <div class="cover" aria-hidden="true">
        <div class="ridi-logo" title="RIDI">
          <div class="ridi-word">RIDI</div>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RIDI Widget</title>
    <style>
      :root {
        --bg: #ffffff;
        --card: rgba(255, 255, 255, 0.92);
        --border: rgba(0, 0, 0, 0.08);
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        --radius: 18px;
        --text: #111;
        --muted: rgba(0, 0, 0, 0.55);
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, "Noto Sans KR", sans-serif;
        background: transparent;
        color: var(--text);
      }

      /* 전체 위젯 카드 */
      .widget {
        width: 100%;
        max-width: 520px;
        margin: 0 auto;
        padding: 16px;
      }

      .bar {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: var(--card);
        box-shadow: var(--shadow);
      }

      /* ✅ RIDI 로고(글자 이미지/박스) 크기 줄이기 */
      .logo {
        flex: 0 0 auto;
        width: 54px;            /* 원래 더 컸다면 여기서 줄어듦 */
        height: 40px;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.03);
        display: grid;
        place-items: center;
        border: 1px solid rgba(0,0,0,0.06);
      }
      .logo img {
        display: block;
        max-width: 34px;        /* ✅ 글자 이미지 크기 */
        max-height: 18px;
        width: auto;
        height: auto;
      }
      /* 로고가 텍스트라면(이미지 없을 때) */
      .logo .logo-text{
        font-weight: 800;
        letter-spacing: 0.5px;
        font-size: 14px;        /* ✅ RIDI 글자 크기 */
        color: #2b66ff;
      }

      .meta {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 0;
        flex: 1;
      }

      .meta-top {
        font-size: 12px;
        color: var(--muted);
        line-height: 1;
      }

      /* 검색 영역 */
      .search-wrap {
        position: relative;   /* ✅ 결과창 absolute 기준 */
        width: 100%;
      }

      form {
        margin: 0;
      }

      input[type="text"] {
        width: 100%;
        height: 40px;
        border-radius: 14px;
        border: 1px solid rgba(0,0,0,0.10);
        padding: 0 14px;
        outline: none;
        font-size: 14px;
        background: rgba(255,255,255,0.9);
      }
      input[type="text"]:focus {
        border-color: rgba(43, 102, 255, 0.55);
        box-shadow: 0 0 0 3px rgba(43, 102, 255, 0.12);
      }

      /* ✅ 검색 결과 창: “중앙 정렬” 핵심 */
      .results {
        position: absolute;
        top: 48px;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;                /* 입력창과 동일 폭 */
        max-width: 100%;
        border-radius: 16px;
        border: 1px solid rgba(0,0,0,0.10);
        background: rgba(255,255,255,0.98);
        box-shadow: 0 16px 40px rgba(0,0,0,0.14);
        overflow: hidden;
        display: none;
        z-index: 50;
      }

      .results.open { display: block; }

      .result-item {
        display: flex;
        gap: 12px;
        padding: 12px 12px;
        cursor: pointer;
      }
      .result-item:hover {
        background: rgba(0,0,0,0.03);
      }
      .thumb {
        flex: 0 0 auto;
        width: 40px;
        height: 56px;
        border-radius: 10px;
        background: rgba(0,0,0,0.06);
        overflow: hidden;
      }
      .thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .info {
        min-width: 0;
        flex: 1;
      }
      .title {
        font-size: 13px;
        font-weight: 700;
        line-height: 1.25;
        margin: 2px 0 4px;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }
      .sub {
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .empty {
        padding: 14px;
        font-size: 13px;
        color: var(--muted);
      }
    </style>
  </head>

  <body>
    <div class="widget">
      <div class="bar">
        <!-- ✅ 로고 이미지가 있으면 img로 넣고, 없으면 아래 텍스트가 보여요 -->
        <div class="logo" aria-label="RIDI">
          <!-- 로고 이미지 파일을 쓰고 있다면 경로만 맞춰줘 (예: /ridi.png) -->
          <!-- <img src="/ridi.png" alt="RIDI" /> -->
          <div class="logo-text">RIDI</div>
</div>
      </div>

      <div class="info">
        <p class="meta">웹소설 · 웹툰</p>
        <div class="meta">
          <div class="meta-top">웹소설 · 웹툰</div>

        <div class="search-wrap" id="searchWrap">
          <form id="searchForm" class="search">
            <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.5"/>
              <line x1="16.65" y1="16.65" x2="21" y2="21" stroke="currentColor" stroke-width="1.5"/>
            </svg>
            <input id="searchInput" type="text" placeholder="제목 검색" autocomplete="off" />
          </form>
          <div class="search-wrap">
            <form id="searchForm" autocomplete="off">
              <input id="searchInput" type="text" placeholder="제목 검색" />
            </form>

          <div id="resultPopover" class="result-popover">
<div id="results" class="results"></div>
</div>
</div>
</div>
</div>
  </div>

<script>
  const SERVER = "https://notion-widget-server1.vercel.app";

  function fallbackCover(title) {
    return `https://placehold.co/300x450.png?text=${encodeURIComponent(title || "cover")}`;
  }
  function safeStr(v){ return v==null ? "" : String(v).trim(); }

  const popover = document.getElementById("resultPopover");
  const resultsRoot = document.getElementById("results");
  const searchWrap = document.getElementById("searchWrap");
  const inputEl = document.getElementById("searchInput");

  function openPopover(){ popover.style.display = "block"; }
  function closePopover(){ popover.style.display = "none"; }

  function normalizeQuery(q){
    return String(q||"")
      .replace(/\[[^\]]*\]/g,"")
      .replace(/\([^)]*\)/g,"")
      .replace(/[·:：\-–—]/g," ")
      .replace(/\s+/g," ")
      .trim();
  }

  let searchAbort = null;
  async function searchRidi(q){
    if(searchAbort) searchAbort.abort();
    searchAbort = new AbortController();
    const res = await fetch(`${SERVER}/api/searchRidi?q=${encodeURIComponent(q)}&debug=0`, { signal: searchAbort.signal });
    return res.json();
  }
  async function getRidiDetail({link, bookId}){
    const qs = link ? `link=${encodeURIComponent(link)}` : `bookId=${encodeURIComponent(bookId||"")}`;
    const res = await fetch(`${SERVER}/api/getRidiDetail?${qs}&debug=0`);
    return res.json();
  }
  async function addToNotion(payload){
    const res = await fetch(`${SERVER}/api/addToNotion`, {
      method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload)
    });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok || !data.ok) throw new Error(data.error || "저장 실패");
    return data;
  }

  async function smartSearch(query){
    const original = String(query||"").trim();
    let data = await searchRidi(original);
    if(data?.ok && data.items?.length) return data;

    const cleaned = normalizeQuery(original);
    if(cleaned && cleaned !== original){
      data = await searchRidi(cleaned);
      if(data?.ok && data.items?.length) return data;
    }

    const words = cleaned.split(" ").filter(Boolean);
    const shortQ = words.slice(0,2).join(" ");
    if(shortQ && shortQ !== cleaned){
      data = await searchRidi(shortQ);
    }
    return data;
  }

  function renderResults(items){
    resultsRoot.innerHTML = "";
    if(!items || items.length === 0){
      resultsRoot.innerHTML = `<div class="empty-msg">검색 결과가 없어요</div>`;
      return;
    }

    items.forEach((it)=>{
      const coverOriginal = safeStr(it.coverUrl);
      const isAdultCover = coverOriginal.includes("cover_adult.png");
      const displayCover = coverOriginal ? (isAdultCover ? fallbackCover(it.title) : coverOriginal) : fallbackCover(it.title);
      const proxiedDisplayCover = `${SERVER}/api/imageProxy?url=${encodeURIComponent(displayCover)}`;
      const isAdult = Boolean(it.isAdult || isAdultCover);

      const row = document.createElement("div");
      row.className = "result-item";

      const thumb = document.createElement("div");
      thumb.className = "result-thumb";

      const img = document.createElement("img");
      img.src = proxiedDisplayCover;
      img.alt = "";
      img.onerror = () => { img.src = fallbackCover(it.title); };
      thumb.appendChild(img);

      if(isAdult){
        const badge = document.createElement("span");
        badge.className = "badge19";
        badge.textContent = "19";
        thumb.appendChild(badge);

    <script>
      // ⚠️ 아래 API 경로는 네 프로젝트에 맞게 유지/수정 필요
      // 예: /api/searchRidi?q=키워드 형태로 이미 만들어뒀다면 그대로 OK
      const API_URL = (q) => `/api/searchRidi?q=${encodeURIComponent(q)}`;

      const $input = document.getElementById("searchInput");
      const $results = document.getElementById("results");

      let timer = null;
      let lastQuery = "";

      function openResults() {
        $results.classList.add("open");
      }
      function closeResults() {
        $results.classList.remove("open");
}

      const info = document.createElement("div");
      info.className = "result-info";

      const title = document.createElement("div");
      title.className = "result-title";
      title.textContent = it.title || "(제목 없음)";
      info.appendChild(title);

      row.appendChild(thumb);
      row.appendChild(info);

      row.addEventListener("click", async ()=>{
        row.style.pointerEvents="none";
        row.style.opacity="0.6";
        try{
          const detail = await getRidiDetail({ link: it.link, bookId: it.bookId });
          if(!detail?.ok) throw new Error(detail?.error || "상세 정보를 가져오지 못했어요");

          const payloadTitle = safeStr(detail.title) || safeStr(it.title);

          const detailCover = safeStr(detail.coverUrl);
          const finalCoverOriginal = detailCover || coverOriginal || displayCover;

          const finalIsAdult =
            Boolean(detail.isAdult) ||
            Boolean(isAdult) ||
            finalCoverOriginal.includes("cover_adult.png");

          // ✅ A안: 성인작품이면 노션 표지 저장 안 함
          const coverForNotion = finalIsAdult ? "" : finalCoverOriginal;

          const payload = {
            title: payloadTitle,
            link: it.link,
            url: it.link,
            coverUrl: coverForNotion,
            isAdult: finalIsAdult,
            authorName: safeStr(detail.authorName),
            publisherName: safeStr(detail.publisherName),
            rating: detail.rating,
            genre: Array.isArray(detail.genre) ? detail.genre : [],
            tags: Array.isArray(detail.tags) ? detail.tags : [],
            description: safeStr(detail.description),
            guide: safeStr(detail.guide),
            bookId: detail.bookId || it.bookId || undefined,
          };

          await addToNotion(payload);
          closePopover(); // 저장 후 닫기 (원하면 삭제)
        }catch(e){
          console.error("save error:", e);
        }finally{
          row.style.pointerEvents="";
          row.style.opacity="";
      function render(items) {
        if (!items || items.length === 0) {
          $results.innerHTML = `<div class="empty">검색 결과가 없어요.</div>`;
          openResults();
          return;
}
      });

      resultsRoot.appendChild(row);
    });
  }

  function debounce(fn, wait=400){
    let t=null;
    return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
  }

  const runSearch = debounce(async (q)=>{
    const query = String(q||"").trim();
    if(!query){
      closePopover(); resultsRoot.innerHTML=""; return;
    }
    openPopover();
    try{
      const data = await smartSearch(query);
      if(!data?.ok){
        resultsRoot.innerHTML = `<div class="empty-msg">검색에 실패했어요</div>`;
        return;
        $results.innerHTML = items
          .slice(0, 8)
          .map((it) => {
            const title = escapeHtml(it.title ?? "");
            const meta = escapeHtml(it.meta ?? it.platform ?? "");
            const cover = it.coverUrl ? `<img src="${it.coverUrl}" alt="">` : "";
            return `
              <div class="result-item" data-link="${it.link ?? ""}">
                <div class="thumb">${cover}</div>
                <div class="info">
                  <div class="title">${title}</div>
                  <div class="sub">${meta}</div>
                </div>
              </div>
            `;
          })
          .join("");

        openResults();
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      async function search(q) {
        try {
          const res = await fetch(API_URL(q));
          const data = await res.json();
          // data.items 형태를 가정
          render(data.items || []);
        } catch (e) {
          $results.innerHTML = `<div class="empty">검색 중 오류가 발생했어요.</div>`;
          openResults();
        }
}
      renderResults(data.items);
    }catch(e){
      if(e?.name==="AbortError") return;
      resultsRoot.innerHTML = `<div class="empty-msg">검색 오류가 발생했어요</div>`;
      console.error(e);
    }
  }, 400);

  document.getElementById("searchForm").addEventListener("submit", (e)=>{
    e.preventDefault();
    runSearch(inputEl.value.trim());
  });
  inputEl.addEventListener("input", (e)=> runSearch(e.target.value));
  inputEl.addEventListener("focus", ()=> { if(String(inputEl.value||"").trim()) openPopover(); });

  document.addEventListener("mousedown", (e)=>{ if(!searchWrap.contains(e.target)) closePopover(); });
  document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closePopover(); });

  closePopover();
</script>
</body>

      $input.addEventListener("input", () => {
        const q = $input.value.trim();
        if (q === lastQuery) return;
        lastQuery = q;

        clearTimeout(timer);

        if (!q) {
          closeResults();
          $results.innerHTML = "";
          return;
        }

        timer = setTimeout(() => search(q), 180);
      });

      document.addEventListener("click", (e) => {
        // 결과창 밖 클릭하면 닫기
        if (!e.target.closest(".search-wrap")) closeResults();
      });

      $results.addEventListener("click", (e) => {
        const row = e.target.closest(".result-item");
        if (!row) return;
        const link = row.getAttribute("data-link");
        if (link) window.open(link, "_blank", "noopener,noreferrer");
        closeResults();
      });
    </script>
  </body>
</html>
