<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Kakao Webtoon Widget</title>
  <style>
    body { margin:0; font-family: system-ui, sans-serif; background:#111; color:#fff; }
    .card { padding:16px; border-radius:12px; background:#1c1c1c; width:360px; }
    input { width:100%; padding:10px; border-radius:8px; border:none; outline:none; margin-top:8px; }
    button { width:100%; padding:10px 12px; border-radius:8px; border:none; cursor:pointer; margin-top:8px; }
    .hint { font-size:12px; color:#aaa; margin-top:8px; line-height:1.35; }
    img { width:100%; border-radius:8px; margin-top:10px; }
    .adult { background:#444; color:#bbb; padding:6px; border-radius:6px; text-align:center; margin-top:10px; }
    .error { margin-top:10px; background:#2a1515; color:#ffb4b4; padding:10px; border-radius:8px; font-size:12px; white-space:pre-wrap; }
    .loading { margin-top:10px; color:#bbb; font-size:12px; }
    a { color:#9ecbff; }
  </style>
</head>
<body>
  <div class="card">
    <div class="hint">
      ✅ 카카오웹툰은 서버 검색이 자주 막혀서,<br/>
      <b>1) 아래 버튼으로 카카오웹툰에서 직접 검색</b> →<br/>
      <b>2) 작품 페이지 URL을 복사</b> →<br/>
      <b>3) 여기 붙여넣기</b> 하면 상세가 뜹니다.
    </div>

    <input id="keyword" placeholder="예: 병아리반 (검색어)" />
    <button id="openSearch">카카오웹툰에서 검색 열기</button>

    <div class="hint">
      작품 페이지 주소 예시:<br/>
      https://webtoon.kakao.com/content/작품명/12345
    </div>

    <input id="urlInput" placeholder="작품 URL 붙여넣기" />
    <button id="loadBtn">이 URL로 상세 불러오기</button>

    <div id="status" class="loading" style="display:none;"></div>
    <div id="error" class="error" style="display:none;"></div>
    <div id="detail"></div>
  </div>

  <script>
    const keyword = document.getElementById("keyword");
    const openSearch = document.getElementById("openSearch");
    const urlInput = document.getElementById("urlInput");
    const loadBtn = document.getElementById("loadBtn");
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");
    const detail = document.getElementById("detail");

    function setLoading(msg) {
      statusEl.style.display = "block";
      statusEl.textContent = msg || "로딩 중...";
    }
    function clearLoading() {
      statusEl.style.display = "none";
      statusEl.textContent = "";
    }
    function showError(msg) {
      errorEl.style.display = "block";
      errorEl.textContent = msg;
    }
    function clearError() {
      errorEl.style.display = "none";
      errorEl.textContent = "";
    }

    openSearch.addEventListener("click", () => {
      const q = (keyword.value || "").trim();
      const url = "https://webtoon.kakao.com/search?keyword=" + encodeURIComponent(q || "");
      window.open(url, "_blank");
    });

    async function loadDetail() {
      const url = (urlInput.value || "").trim();
      if (!url) return;

      clearError();
      detail.innerHTML = "";
      setLoading("상세 불러오는 중...");

      try {
        const res = await fetch("/api/getKakaoDetail?url=" + encodeURIComponent(url));
        const d = await res.json();
        if (!d.ok) throw new Error(d.error || "getKakaoDetail failed");

        detail.innerHTML = `
          <h3 style="margin:12px 0 6px;">${d.title || ""}</h3>
          ${d.isAdult ? `<div class="adult">19세 이용가</div>` : (d.cover ? `<img src="${d.cover}" />` : "")}
          <div class="hint">${d.platform || "카카오웹툰"}</div>
          <p style="font-size:13px; line-height:1.45;">${d.desc || ""}</p>
          <div class="hint"><a href="${d.url}" target="_blank">카카오웹툰에서 열기</a></div>
        `;
      } catch (e) {
        showError("상세 실패: " + (e?.message || e));
      } finally {
        clearLoading();
      }
    }

    loadBtn.addEventListener("click", loadDetail);
    urlInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") loadDetail();
    });
  </script>
</body>
</html>
