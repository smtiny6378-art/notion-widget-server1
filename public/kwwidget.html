<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Kakao Webtoon Widget</title>
  <style>
    body { margin:0; font-family: system-ui, sans-serif; background:#111; color:#fff; }
    .card { padding:16px; border-radius:12px; background:#1c1c1c; width:320px; }
    .row { display:flex; gap:8px; }
    input { flex:1; padding:10px; border-radius:8px; border:none; outline:none; }
    button { padding:10px 12px; border-radius:8px; border:none; cursor:pointer; }
    .hint { font-size:12px; color:#aaa; margin-top:8px; }
    .item { padding:8px; border-bottom:1px solid #333; cursor:pointer; }
    .item:hover { background:#222; }
    img { width:100%; border-radius:8px; margin-top:8px; }
    .adult { background:#444; color:#bbb; padding:6px; border-radius:6px; text-align:center; margin-top:8px; }
    .error { margin-top:10px; background:#2a1515; color:#ffb4b4; padding:10px; border-radius:8px; font-size:12px; white-space:pre-wrap; }
    .loading { margin-top:10px; color:#bbb; font-size:12px; }
  </style>
</head>
<body>
  <div class="card">
    <div class="row">
      <input id="q" placeholder="카카오웹툰 제목 검색 (엔터)" />
      <button id="btn">검색</button>
    </div>
    <div class="hint">검색 후 목록에서 클릭하면 상세가 나와요.</div>

    <div id="status" class="loading" style="display:none;"></div>
    <div id="error" class="error" style="display:none;"></div>

    <div id="list"></div>
    <div id="detail"></div>
  </div>

  <script>
    const q = document.getElementById("q");
    const btn = document.getElementById("btn");
    const list = document.getElementById("list");
    const detail = document.getElementById("detail");
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");

    function setLoading(msg) {
      statusEl.style.display = "block";
      statusEl.textContent = msg || "로딩 중...";
    }
    function clearLoading() {
      statusEl.style.display = "none";
      statusEl.textContent = "";
    }
    function showError(msg) {
      errorEl.style.display = "block";
      errorEl.textContent = msg;
    }
    function clearError() {
      errorEl.style.display = "none";
      errorEl.textContent = "";
    }

    async function doSearch() {
      const keyword = (q.value || "").trim();
      if (!keyword) return;

      clearError();
      detail.innerHTML = "";
      list.innerHTML = "";
      setLoading("검색 중...");

      try {
        const res = await fetch("/api/searchKakao?q=" + encodeURIComponent(keyword));
        const data = await res.json();

        if (!data.ok) throw new Error(data.error || "searchKakao failed");

        if (!data.items || data.items.length === 0) {
          list.innerHTML = `<div class="hint">검색 결과가 없어요.</div>`;
          return;
        }

        list.innerHTML = data.items.map(i =>
          `<div class="item" data-id="${i.contentId}">${i.title}</div>`
        ).join("");
      } catch (e) {
        showError("검색 실패: " + (e?.message || e));
      } finally {
        clearLoading();
      }
    }

    btn.addEventListener("click", doSearch);
    q.addEventListener("keydown", (e) => {
      if (e.key === "Enter") doSearch();
    });

    list.addEventListener("click", async (e) => {
      const id = e.target.dataset.id;
      if (!id) return;

      clearError();
      detail.innerHTML = "";
      setLoading("상세 불러오는 중...");

      try {
        const res = await fetch("/api/getKakaoDetail?contentId=" + encodeURIComponent(id));
        const d = await res.json();
        if (!d.ok) throw new Error(d.error || "getKakaoDetail failed");

        detail.innerHTML = `
          <h3 style="margin:12px 0 6px;">${d.title || ""}</h3>
          ${d.isAdult ? `<div class="adult">19세 이용가</div>` : (d.cover ? `<img src="${d.cover}" />` : "")}
          <div class="hint">${d.platform || ""}</div>
          <p style="font-size:13px; line-height:1.45;">${d.desc || ""}</p>
          <div class="hint"><a href="${d.url}" target="_blank" style="color:#9ecbff;">카카오웹툰에서 열기</a></div>
        `;
      } catch (e) {
        showError("상세 실패: " + (e?.message || e));
      } finally {
        clearLoading();
      }
    });
  </script>
</body>
</html>
