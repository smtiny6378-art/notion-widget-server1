<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KakaoPage â†’ Notion</title>
  <style>
    :root{
      --kp-yellow: #FFE400;
      --kp-yellow-soft: rgba(255, 228, 0, .18);
      --text: #111;
      --muted: rgba(0,0,0,.55);
      --line: rgba(0,0,0,.12);
      --line2: rgba(0,0,0,.18);
      --ok: #0a7a2f;
      --err: #b00020;
      --card: rgba(255,255,255,.96);
      --bg: transparent;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    /* âœ… ë¦¬ë”” ìœ„ì ¯ ëŠë‚Œ: í° ì»¬ëŸ¬ í…Œë‘ë¦¬ */
    .frame{
      width:100%;
      max-width: 720px;
      margin: 0 auto;
      padding: 12px;
      border-radius: 18px;
      border: 2px solid rgba(255, 228, 0, .95);
      background: rgba(255, 228, 0, .10);
    }

    .wrap{
      border-radius: 16px;
      background: var(--card);
      border: 1px solid var(--line);
      padding: 12px;
    }

    /* âœ… ìƒë‹¨: ì¢Œì¸¡ ë¡œê³  + íƒ€ì´í‹€ */
    .top{
      display:flex;
      gap:12px;
      align-items:center;
      padding: 10px 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.02);
      border: 1px solid var(--line);
    }

    .logo{
      width:44px;
      height:44px;
      border-radius: 14px;
      background: var(--kp-yellow);
      color:#111;
      display:grid;
      place-items:center;
      font-weight: 900;
      letter-spacing: .2px;
      flex: 0 0 auto;
      border: 1px solid rgba(0,0,0,.10);
    }

    .top-right{
      min-width: 0;
      flex: 1 1 auto;
    }

    /* âœ… "ì¹´ì¹´ì˜¤í˜ì´ì§€ URL" ë³¼ë“œ */
    .title{
      font-weight: 900;
      font-size: 14px;
      line-height: 1.2;
    }

    .sub{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    /* âœ… ì…ë ¥ ì„¹ì…˜: íƒ€ì´í‹€(ë³¼ë“œ) + ì•„ë˜ ì…ë ¥ ë°•ìŠ¤ */
    .section{
      margin-top: 12px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.015);
    }

    .sec-title{
      font-weight: 900;
      font-size: 13px;
      margin-bottom: 8px;
    }

    textarea{
      width:100%;
      min-height: 120px;
      resize: vertical;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.98);
      font-size: 13px;
      color: var(--text);
      outline: none;
    }
    textarea::placeholder{ color: rgba(0,0,0,.35); }

    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
      align-items:center;
    }

    button{
      all:unset;
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line2);
      background: rgba(0,0,0,.04);
      font-size: 13px;
      font-weight: 800;
      user-select:none;
    }
    button:hover{ background: rgba(0,0,0,.06); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .primary{
      background: rgba(255, 228, 0, .55);
      border-color: rgba(255, 228, 0, .95);
    }
    .primary:hover{ background: rgba(255, 228, 0, .70); }

    .toast{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.03);
      color: var(--muted);
      font-size: 12px;
      min-height: 40px;
      display:flex;
      align-items:center;
      white-space: pre-wrap;
    }
    .ok{ color: var(--ok); }
    .err{ color: var(--err); }

    .log{
      margin-top: 10px;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(0,0,0,.02);
      font-size: 12px;
      color: var(--text);
      line-height: 1.45;
      max-height: 220px;
      overflow: auto;
      white-space: pre-wrap;
    }
    .log .muted{ color: var(--muted); }
  </style>
</head>

<body>
  <div class="frame">
    <div class="wrap">

      <div class="top">
        <div class="logo" aria-label="KakaoPage">KP</div>
        <div class="top-right">
          <div class="title">ì¹´ì¹´ì˜¤í˜ì´ì§€ URL</div>
          <div class="sub">ì‘í’ˆ URLì„ ì—¬ëŸ¬ ì¤„ë¡œ ë¶™ì—¬ë„£ê³  í•œ ë²ˆì— ì €ì¥í•  ìˆ˜ ìˆì–´ìš”.</div>
        </div>
      </div>

      <div class="section">
        <div class="sec-title">ì¹´ì¹´ì˜¤í˜ì´ì§€ URL</div>
        <textarea id="contentUrls" placeholder="ì—¬ê¸°ì— ì‘í’ˆ URLì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš” (ì¤„ë°”ê¿ˆìœ¼ë¡œ ì—¬ëŸ¬ ê°œ)"></textarea>

        <div class="btns">
          <button class="primary" id="saveBtn">ë…¸ì…˜ì— ì €ì¥</button>
          <button id="openFirstBtn">ì²« ë²ˆì§¸ URL ì—´ê¸°</button>
          <button id="clearBtn">ì…ë ¥ ì§€ìš°ê¸°</button>
        </div>

        <div class="toast" id="toast">URLì„ ì…ë ¥í•˜ê³  â€œë…¸ì…˜ì— ì €ì¥â€ì„ ëˆŒëŸ¬ ë³´ì„¸ìš”.</div>
        <div class="log" id="log"><span class="muted">ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë¼ìš”.</span></div>
      </div>

    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function setToast(text, cls=""){
      const el = $("toast");
      el.className = "toast " + cls;
      el.textContent = text || "";
    }

    function appendLog(line){
      const el = $("log");
      if (el.textContent.includes("ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë¼ìš”.")) el.textContent = "";
      el.textContent += (el.textContent ? "\n" : "") + line;
      el.scrollTop = el.scrollHeight;
    }

    function openInNewTab(url){
      window.open(url, "_blank", "noopener,noreferrer");
    }

    function parseTextarea(raw){
      return String(raw || "").split(/\r?\n/);
    }

    function normalizeUrls(raw){
      const lines = parseTextarea(raw);
      const trimmedNonEmpty = lines.map(s => s.trim()).filter(Boolean);

      // ì¤‘ë³µ ì œê±°(ìˆœì„œ ìœ ì§€)
      const seen = new Set();
      const unique = [];
      for (const u of trimmedNonEmpty){
        if (seen.has(u)) continue;
        seen.add(u);
        unique.push(u);
      }

      const valid = [];
      const invalid = [];

      for (const u of unique){
        try {
          const parsed = new URL(u);
          if (!/page\.kakao\.com$/i.test(parsed.hostname)){
            invalid.push(u);
            continue;
          }
          valid.push(u);
        } catch {
          invalid.push(u);
        }
      }
      return { valid, invalid };
    }

    function removeSucceededFromTextarea(succeededSet){
      const lines = parseTextarea($("contentUrls").value);

      const kept = [];
      for (const line of lines){
        const t = line.trim();
        if (!t) { kept.push(line); continue; }
        if (succeededSet.has(t)) continue;
        kept.push(line);
      }

      // ë¹ˆì¤„ ì •ë¦¬: 3ì¤„ ì´ìƒ ì—°ì† ë¹ˆì¤„ì„ 2ì¤„ë¡œ ì œí•œ + ì•ë’¤ ë¹ˆì¤„ ì œê±°
      const compact = [];
      let emptyRun = 0;
      for (const line of kept){
        if (!line.trim()){
          emptyRun++;
          if (emptyRun <= 2) compact.push("");
        } else {
          emptyRun = 0;
          compact.push(line.trim());
        }
      }
      while (compact.length && !compact[0].trim()) compact.shift();
      while (compact.length && !compact[compact.length-1].trim()) compact.pop();

      $("contentUrls").value = compact.join("\n");
    }

    async function postJson(path, payload){
      const r = await fetch(path, {
        method: "POST",
        headers: { "content-type":"application/json" },
        body: JSON.stringify(payload)
      });
      const text = await r.text();
      let data;
      try { data = JSON.parse(text); }
      catch { data = { ok:false, error:"Non-JSON response", detail:text.slice(0,200) }; }
      return { status: r.status, data };
    }

    function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }

    $("openFirstBtn").addEventListener("click", () => {
      const { valid } = normalizeUrls($("contentUrls").value);
      if (!valid.length) return setToast("ë¨¼ì € ì‘í’ˆ URLì„ 1ê°œ ì´ìƒ ë„£ì–´ ì£¼ì„¸ìš”.", "err");
      openInNewTab(valid[0]);
      setToast("ì²« ë²ˆì§¸ URLì„ ìƒˆ íƒ­ìœ¼ë¡œ ì—´ì—ˆì–´ìš”.");
    });

    $("clearBtn").addEventListener("click", () => {
      $("contentUrls").value = "";
      $("log").textContent = "ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë¼ìš”.";
      setToast("ì…ë ¥ì„ ì§€ì› ì–´ìš”.");
    });

    $("saveBtn").addEventListener("click", async () => {
      const raw = $("contentUrls").value;
      const { valid, invalid } = normalizeUrls(raw);

      if (!valid.length){
        return setToast("ì €ì¥í•  URLì´ ì—†ì–´ìš”. ì¤„ë°”ê¿ˆìœ¼ë¡œ URLì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.", "err");
      }

      // UI ì ê¸ˆ
      $("saveBtn").disabled = true;
      $("openFirstBtn").disabled = true;
      $("clearBtn").disabled = true;

      $("log").textContent = "";
      if (invalid.length){
        appendLog(`âš ï¸ ì œì™¸ëœ URL ${invalid.length}ê°œ:`);
        for (const u of invalid) appendLog(`  - ${u}`);
        appendLog("");
      }

      setToast(`ì €ì¥ ì‹œì‘: ${valid.length}ê°œ`, "");
      appendLog(`âœ… ì €ì¥ ì‹œì‘ (${valid.length}ê°œ)`);

      let okCount = 0;
      let failCount = 0;
      const succeeded = new Set();

      const GAP_MS = 250;

      for (let i = 0; i < valid.length; i++){
        const url = valid[i];
        setToast(`ì €ì¥ ì¤‘â€¦ (${i+1}/${valid.length})`, "");
        appendLog(`â³ (${i+1}/${valid.length}) ì €ì¥ ìš”ì²­: ${url}`);

        try {
          const res = await postJson("/api/notion-create", { platform: "ì¹´ì¹´ì˜¤í˜ì´ì§€", url });

          if (res.data && res.data.ok){
            okCount++;
            succeeded.add(url);

            const dbg = res.data.debug
              ? ` (upstream: ${res.data.debug.upstreamStatus}${res.data.debug.redirectedTo ? ", redirected" : ""})`
              : "";
            appendLog(`âœ… ì™„ë£Œ: ${url}${dbg}`);
          } else {
            failCount++;
            appendLog(`âŒ ì‹¤íŒ¨: ${url} â€” ${res.data?.error || "unknown"}`);
          }
        } catch (e){
          failCount++;
          appendLog(`âŒ ì‹¤íŒ¨: ${url} â€” ${String(e?.message || e)}`);
        }

        await sleep(GAP_MS);
      }

      if (succeeded.size){
        removeSucceededFromTextarea(succeeded);
        appendLog("");
        appendLog(`ğŸ§¹ ì…ë ¥ì°½ ì •ë¦¬: ì„±ê³µ ${succeeded.size}ê°œ URLì„ ì œê±°í–ˆì–´ìš”.`);
      }

      if (failCount === 0){
        setToast(`ì €ì¥ ì™„ë£Œ! ${okCount}/${valid.length}ê°œ ì„±ê³µ`, "ok");
      } else if (okCount === 0){
        setToast(`ì €ì¥ ì‹¤íŒ¨â€¦ ${failCount}/${valid.length}ê°œ ì‹¤íŒ¨`, "err");
      } else {
        setToast(`ì €ì¥ ì™„ë£Œ (ì„±ê³µ ${okCount}, ì‹¤íŒ¨ ${failCount})`, "");
      }

      // UI ì ê¸ˆ í•´ì œ
      $("saveBtn").disabled = false;
      $("openFirstBtn").disabled = false;
      $("clearBtn").disabled = false;
    });
  </script>
</body>
</html>
