<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KakaoPage → Notion</title>
  <style>
    :root {
      --bg: #0b0b0c;
      --card: #141416;
      --text: #e9e9ea;
      --muted: #a8a8ad;
      --line: rgba(255,255,255,.10);
      --accent: #ffe400;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: transparent;
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }
    .wrap {
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
      width: 100%;
      max-width: 560px;
      margin: 0 auto;
    }
    .top {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .badge {
      width: 44px; height: 44px;
      border-radius: 12px;
      background: var(--accent);
      color: #111;
      display: grid;
      place-items: center;
      font-weight: 900;
    }
    .title { font-weight: 800; font-size: 16px; }
    .sub { color: var(--muted); font-size: 12px; margin-top: 2px; }
    form { margin-top: 12px; }
    .search {
      display: flex;
      gap: 10px;
      align-items: center;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 12px;
      padding: 10px 12px;
    }
    input {
      all: unset;
      flex: 1;
      font-size: 14px;
      color: var(--text);
    }
    button {
      all: unset;
      cursor: pointer;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(255,255,255,.10);
      border: 1px solid var(--line);
      font-size: 13px;
    }
    button:hover { background: rgba(255,255,255,.14); }
    .list { margin-top: 12px; display: grid; gap: 10px; }
    .item {
      display: grid;
      grid-template-columns: 56px 1fr auto;
      gap: 12px;
      align-items: center;
      padding: 10px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
    }
    .cover {
      width: 56px; height: 76px;
      border-radius: 10px;
      background: rgba(255,255,255,.08);
      overflow: hidden;
    }
    .cover img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .it-title { font-weight: 800; font-size: 14px; line-height: 1.25; }
    .it-meta { color: var(--muted); font-size: 12px; margin-top: 4px; }
    .pill {
      font-size: 11px;
      color: var(--muted);
      border: 1px solid var(--line);
      padding: 6px 8px;
      border-radius: 999px;
      white-space: nowrap;
    }
    .msg { margin-top: 10px; color: var(--muted); font-size: 12px; }
    .ok { color: #9be59b; }
    .err { color: #ff8f8f; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="badge">KP</div>
      <div>
        <div class="title">카카오페이지 검색 → 노션 저장</div>
        <div class="sub">검색하고 결과를 클릭하면 노션 DB에 페이지가 생성돼요</div>
      </div>
    </div>

    <form id="f">
      <div class="search">
        <input id="q" placeholder="작품 제목을 입력" autocomplete="off" />
        <button id="go" type="submit">검색</button>
      </div>
    </form>

    <div id="msg" class="msg"></div>
    <div id="list" class="list"></div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const msg = (text, cls="") => {
      $("msg").className = "msg " + cls;
      $("msg").textContent = text || "";
    };

    function escapeHtml(s) {
      return (s || "").replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
    }

    async function searchKakaoPage(query) {
      const r = await fetch(`/api/kakaopage-search?q=${encodeURIComponent(query)}`);
      const data = await r.json();
      if (!data.ok) throw new Error(data.error || "검색 실패");
      return data.items || [];
    }

    async function saveToNotion(item) {
      const r = await fetch(`/api/notion-create`, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({
          title: item.title,
          platform: "카카오페이지",
          url: item.link,
          coverUrl: item.coverUrl,
          author: item.author,
          genre: item.genre,
          ageGrade: item.ageGrade
        })
      });
      const data = await r.json();
      if (!data.ok) throw new Error(data.error || "노션 저장 실패");
      return data;
    }

    function render(items) {
      const root = $("list");
      if (!items.length) {
        root.innerHTML = "";
        msg("검색 결과가 없어요.");
        return;
      }

      root.innerHTML = items.map((it, idx) => {
        const metaParts = [];
        if (it.author) metaParts.push(it.author);
        if (it.genre) metaParts.push(it.genre);
        if (it.ageGrade !== null && it.ageGrade !== undefined) metaParts.push(`연령 ${it.ageGrade}`);

        return `
          <div class="item" data-idx="${idx}">
            <div class="cover">${it.coverUrl ? `<img src="${escapeHtml(it.coverUrl)}" alt="">` : ""}</div>
            <div>
              <div class="it-title">${escapeHtml(it.title)}</div>
              <div class="it-meta">${escapeHtml(metaParts.join(" · ") || "카카오페이지")}</div>
            </div>
            <div class="pill">노션 저장</div>
          </div>
        `;
      }).join("");

      [...root.querySelectorAll(".item")].forEach(el => {
        el.addEventListener("click", async () => {
          const idx = Number(el.dataset.idx);
          const item = items[idx];
          msg("노션에 저장 중…");
          try {
            const r = await saveToNotion(item);
            msg(`저장 완료! (pageId: ${r.pageId})`, "ok");
          } catch (e) {
            msg(e.message || "저장 실패", "err");
          }
        });
      });
    }

    $("f").addEventListener("submit", async (e) => {
      e.preventDefault();
      const q = $("q").value.trim();
      if (!q) return msg("검색어를 입력해 줘.");
      msg("검색 중…");
      $("list").innerHTML = "";
      try {
        const items = await searchKakaoPage(q);
        msg("");
        render(items);
      } catch (e) {
        msg(e.message || "검색 실패", "err");
      }
    });
  </script>
</body>
</html>
