<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KakaoPage â†’ Notion</title>
  <style>
    :root{
      --text:#111;
      --muted:#666;
      --line: rgba(0,0,0,.12);
      --line2: rgba(0,0,0,.18);
      --ok:#0a7a2f;
      --err:#b00020;
      --bg: transparent;
      --card: rgba(255,255,255,.92);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }
    .wrap{
      width:100%;
      max-width: 720px;
      margin: 0 auto;
      padding: 12px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
    }
    .title{
      font-weight: 900;
      font-size: 14px;
      line-height: 1.2;
      margin-bottom: 6px;
    }
    .sub{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
      margin-bottom: 10px;
    }
    label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin: 8px 0 6px;
    }
    textarea{
      width:100%;
      min-height: 120px;
      resize: vertical;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.95);
      font-size: 13px;
      color: var(--text);
      outline: none;
    }
    textarea::placeholder{ color: rgba(0,0,0,.35); }
    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
      align-items:center;
    }
    button{
      all:unset;
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line2);
      background: rgba(0,0,0,.04);
      font-size: 13px;
      font-weight: 800;
      user-select:none;
    }
    button:hover{ background: rgba(0,0,0,.06); }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    .primary{
      background: rgba(255, 228, 0, .55);
      border-color: rgba(255, 228, 0, .9);
    }
    .primary:hover{ background: rgba(255, 228, 0, .7); }
    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }
    .hint code{
      background: rgba(0,0,0,.04);
      border: 1px solid var(--line);
      padding: 2px 6px;
      border-radius: 8px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
    }
    .toast{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.03);
      color: var(--muted);
      font-size: 12px;
      min-height: 40px;
      display:flex;
      align-items:center;
      white-space: pre-wrap;
    }
    .ok{ color: var(--ok); }
    .err{ color: var(--err); }
    .log{
      margin-top: 10px;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(0,0,0,.02);
      font-size: 12px;
      color: var(--text);
      line-height: 1.45;
      max-height: 220px;
      overflow: auto;
      white-space: pre-wrap;
    }
    .log .muted{ color: var(--muted); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">ì¹´ì¹´ì˜¤í˜ì´ì§€ URL â†’ ë…¸ì…˜ ì €ì¥</div>
    <div class="sub">
      ì‘í’ˆ URLì„ <b>ì—¬ëŸ¬ ì¤„</b>ë¡œ ë¶™ì—¬ë„£ê³  <b>í•œ ë²ˆì— ì €ì¥</b>í•  ìˆ˜ ìˆì–´ìš”.<br/>
      ì €ì¥ ì„±ê³µí•œ URLì€ ìë™ìœ¼ë¡œ ì…ë ¥ì°½ì—ì„œ ì œê±°ë¼ìš”(ì‹¤íŒ¨í•œ ê²ƒë§Œ ë‚¨ìŒ).
    </div>

    <label for="contentUrls">ì¹´ì¹´ì˜¤í˜ì´ì§€ ì‘í’ˆ URL (ì¤„ë°”ê¿ˆìœ¼ë¡œ ì—¬ëŸ¬ ê°œ)</label>
    <textarea id="contentUrls" placeholder="ì˜ˆ:
https://page.kakao.com/content/65171279
https://page.kakao.com/content/12345678"></textarea>

    <div class="btns">
      <button class="primary" id="saveBtn">ë…¸ì…˜ì— ì €ì¥</button>
      <button id="openFirstBtn">ì²« ë²ˆì§¸ URL ì—´ê¸°</button>
      <button id="clearBtn">ì…ë ¥ ì§€ìš°ê¸°</button>
    </div>

    <div class="hint">
      ì‘í’ˆ URL ì˜ˆì‹œ: <code>https://page.kakao.com/content/65171279</code><br/>
      ì„œë²„ëŠ” ì €ì¥ ì‹œ ì‘í’ˆ ë©”íƒ€(ì œëª©/í‘œì§€/ì†Œê°œ)ë„ ì‹œë„í•˜ê³ , ë§‰íˆë©´ URL ê¸°ë°˜ìœ¼ë¡œ ì €ì¥ë¼ìš”.
    </div>

    <div class="toast" id="toast">URLì„ ë¶™ì—¬ë„£ê³  â€œë…¸ì…˜ì— ì €ì¥â€ì„ ëˆŒëŸ¬ ë³´ì„¸ìš”.</div>
    <div class="log" id="log"><span class="muted">ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë¼ìš”.</span></div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function setToast(text, cls=""){
      const el = $("toast");
      el.className = "toast " + cls;
      el.textContent = text || "";
    }

    function appendLog(line){
      const el = $("log");
      if (el.textContent.includes("ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë¼ìš”.")) el.textContent = "";
      el.textContent += (el.textContent ? "\n" : "") + line;
      el.scrollTop = el.scrollHeight;
    }

    function openInNewTab(url){
      window.open(url, "_blank", "noopener,noreferrer");
    }

    // âœ… ì›ë³¸ ì¤„ ëª©ë¡(ê³µë°±/ë¹ˆì¤„ í¬í•¨)ì„ ìœ ì§€í•˜ë©´ì„œ,
    //    ìœ íš¨ URLë§Œ ì¶”ì¶œ + ì¤‘ë³µ ì œê±° + ìœ íš¨ì„± ê²€ì¦
    function parseTextarea(raw){
      const lines = String(raw || "").split(/\r?\n/);
      return lines;
    }

    function normalizeUrls(raw){
      const lines = parseTextarea(raw);

      const trimmedNonEmpty = lines.map(s => s.trim()).filter(Boolean);

      // ì¤‘ë³µ ì œê±°(ìˆœì„œ ìœ ì§€)
      const seen = new Set();
      const unique = [];
      for (const u of trimmedNonEmpty){
        if (seen.has(u)) continue;
        seen.add(u);
        unique.push(u);
      }

      const valid = [];
      const invalid = [];

      for (const u of unique){
        try {
          const parsed = new URL(u);
          if (!/page\.kakao\.com$/i.test(parsed.hostname)){
            invalid.push(u);
            continue;
          }
          valid.push(u);
        } catch {
          invalid.push(u);
        }
      }
      return { valid, invalid };
    }

    // âœ… ì €ì¥ ì„±ê³µí•œ URLì„ textareaì—ì„œ ì œê±° (ì‹¤íŒ¨/ë¯¸ì‹œë„ URLì€ ìœ ì§€)
    function removeSucceededFromTextarea(succeededSet){
      const lines = parseTextarea($("contentUrls").value);

      // ê° ì¤„ì„ trimí•œ ê°’ì´ succeededSetì— ìˆìœ¼ë©´ ê·¸ ì¤„ ì œê±°
      const kept = [];
      for (const line of lines){
        const t = line.trim();
        if (!t) { kept.push(line); continue; } // ë¹ˆ ì¤„ì€ ìœ ì§€(ì •ë¦¬ ì›í•˜ë©´ ì—¬ê¸°ì„œ ì œê±° ê°€ëŠ¥)
        if (succeededSet.has(t)) continue;
        kept.push(line);
      }

      // ì—°ì† ë¹ˆì¤„ ê³¼ë‹¤ë¥¼ ì¡°ê¸ˆ ì •ë¦¬(ì„ íƒ): ì•ë’¤ ê³µë°± ì¤„ ì œê±° + 3ì¤„ ì´ìƒ ë¹ˆì¤„ì€ 2ì¤„ë¡œ ì œí•œ
      const compact = [];
      let emptyRun = 0;
      for (const line of kept){
        if (!line.trim()){
          emptyRun++;
          if (emptyRun <= 2) compact.push("");
        } else {
          emptyRun = 0;
          compact.push(line.trim());
        }
      }

      // ë§¨ ì•/ë’¤ ë¹ˆ ì¤„ ì œê±°
      while (compact.length && !compact[0].trim()) compact.shift();
      while (compact.length && !compact[compact.length-1].trim()) compact.pop();

      $("contentUrls").value = compact.join("\n");
    }

    async function postJson(path, payload){
      const r = await fetch(path, {
        method: "POST",
        headers: { "content-type":"application/json" },
        body: JSON.stringify(payload)
      });
      const text = await r.text();
      let data;
      try { data = JSON.parse(text); }
      catch { data = { ok:false, error:"Non-JSON response", detail:text.slice(0,200) }; }
      return { status: r.status, data };
    }

    function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }

    $("openFirstBtn").addEventListener("click", () => {
      const { valid } = normalizeUrls($("contentUrls").value);
      if (!valid.length) return setToast("ë¨¼ì € ì‘í’ˆ URLì„ 1ê°œ ì´ìƒ ë„£ì–´ ì£¼ì„¸ìš”.", "err");
      openInNewTab(valid[0]);
      setToast("ì²« ë²ˆì§¸ URLì„ ìƒˆ íƒ­ìœ¼ë¡œ ì—´ì—ˆì–´ìš”.");
    });

    $("clearBtn").addEventListener("click", () => {
      $("contentUrls").value = "";
      $("log").textContent = "ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë¼ìš”.";
      setToast("ì…ë ¥ì„ ì§€ì› ì–´ìš”.");
    });

    $("saveBtn").addEventListener("click", async () => {
      const raw = $("contentUrls").value;
      const { valid, invalid } = normalizeUrls(raw);

      if (!valid.length){
        return setToast("ì €ì¥í•  URLì´ ì—†ì–´ìš”. ì¤„ë°”ê¿ˆìœ¼ë¡œ URLì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.", "err");
      }

      // UI ì ê¸ˆ
      $("saveBtn").disabled = true;
      $("openFirstBtn").disabled = true;
      $("clearBtn").disabled = true;

      $("log").textContent = "";
      if (invalid.length){
        appendLog(`âš ï¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šê±°ë‚˜ í—ˆìš©ë˜ì§€ ì•Šì€ URL ${invalid.length}ê°œëŠ” ì œì™¸í–ˆì–´ìš”:`);
        for (const u of invalid) appendLog(`  - ${u}`);
        appendLog("");
      }

      setToast(`ì €ì¥ ì‹œì‘: ${valid.length}ê°œ`, "");
      appendLog(`âœ… ì €ì¥ ì‹œì‘ (${valid.length}ê°œ)`);

      let okCount = 0;
      let failCount = 0;

      // âœ… ì„±ê³µí•œ URLë“¤ì„ ëª¨ì•„ë‘ì—ˆë‹¤ê°€ ë§ˆì§€ë§‰ì— ì…ë ¥ì°½ì—ì„œ ì œê±°
      const succeeded = new Set();

      const GAP_MS = 250;

      for (let i = 0; i < valid.length; i++){
        const url = valid[i];
        setToast(`ì €ì¥ ì¤‘â€¦ (${i+1}/${valid.length})`, "");
        appendLog(`â³ (${i+1}/${valid.length}) ì €ì¥ ìš”ì²­: ${url}`);

        try {
          const res = await postJson("/api/notion-create", { platform: "ì¹´ì¹´ì˜¤í˜ì´ì§€", url });

          if (res.data && res.data.ok){
            okCount++;
            succeeded.add(url);

            const dbg = res.data.debug
              ? ` (upstream: ${res.data.debug.upstreamStatus}${res.data.debug.redirectedTo ? ", redirected" : ""})`
              : "";
            appendLog(`âœ… ì™„ë£Œ: ${url}${dbg}`);
          } else {
            failCount++;
            appendLog(`âŒ ì‹¤íŒ¨: ${url} â€” ${res.data?.error || "unknown"}`);
          }
        } catch (e){
          failCount++;
          appendLog(`âŒ ì‹¤íŒ¨: ${url} â€” ${String(e?.message || e)}`);
        }

        await sleep(GAP_MS);
      }

      // âœ… ì €ì¥ ì„±ê³µí•œ URLì€ ì…ë ¥ì°½ì—ì„œ ìë™ ì œê±° (ì‹¤íŒ¨í•œ ê²ƒë§Œ ë‚¨ê¹€)
      if (succeeded.size){
        removeSucceededFromTextarea(succeeded);
        appendLog("");
        appendLog(`ğŸ§¹ ì…ë ¥ì°½ ì •ë¦¬: ì„±ê³µ ${succeeded.size}ê°œ URLì„ ì œê±°í–ˆì–´ìš”.`);
      }

      if (failCount === 0){
        setToast(`ì €ì¥ ì™„ë£Œ! ${okCount}/${valid.length}ê°œ ì„±ê³µ (ì…ë ¥ì°½ì—ì„œ ì œê±°ë¨)`, "ok");
      } else if (okCount === 0){
        setToast(`ì €ì¥ ì‹¤íŒ¨â€¦ ${failCount}/${valid.length}ê°œ ì‹¤íŒ¨`, "err");
      } else {
        setToast(`ì €ì¥ ì™„ë£Œ (ì„±ê³µ ${okCount}, ì‹¤íŒ¨ ${failCount}) â€” ì‹¤íŒ¨í•œ URLë§Œ ì…ë ¥ì°½ì— ë‚¨ì•˜ì–´ìš”`, "");
      }

      // UI ì ê¸ˆ í•´ì œ
      $("saveBtn").disabled = false;
      $("openFirstBtn").disabled = false;
      $("clearBtn").disabled = false;
    });
  </script>
</body>
</html>
