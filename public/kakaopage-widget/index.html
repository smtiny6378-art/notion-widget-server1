<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KakaoPage → Notion</title>
  <style>
    :root{
      --text:#111;
      --muted:#666;
      --line: rgba(0,0,0,.12);
      --line2: rgba(0,0,0,.18);
      --ok:#0a7a2f;
      --err:#b00020;
      --bg: transparent; /* ✅ 노션 임베드 배경과 자연스럽게 */
      --card: rgba(255,255,255,.92); /* ✅ 흰 카드 느낌 (원하면 transparent로 바꿔도 됨) */
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    /* ✅ 검은 배경 박스 제거: 얇고 깔끔한 흰 카드만 */
    .wrap{
      width:100%;
      max-width: 720px;
      margin: 0 auto;
      padding: 12px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
    }

    .title{
      font-weight: 900;
      font-size: 14px;
      line-height: 1.2;
      margin-bottom: 6px;
    }
    .sub{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
      margin-bottom: 10px;
    }

    label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin: 8px 0 6px;
    }

    textarea{
      width:100%;
      min-height: 120px;
      resize: vertical;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.95);
      font-size: 13px;
      color: var(--text);
      outline: none;
    }
    textarea::placeholder{ color: rgba(0,0,0,.35); }

    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
      align-items:center;
    }

    button{
      all:unset;
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line2);
      background: rgba(0,0,0,.04);
      font-size: 13px;
      font-weight: 800;
      user-select:none;
    }
    button:hover{ background: rgba(0,0,0,.06); }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .primary{
      background: rgba(255, 228, 0, .55);
      border-color: rgba(255, 228, 0, .9);
    }
    .primary:hover{ background: rgba(255, 228, 0, .7); }

    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }
    .hint code{
      background: rgba(0,0,0,.04);
      border: 1px solid var(--line);
      padding: 2px 6px;
      border-radius: 8px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
    }

    .toast{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.03);
      color: var(--muted);
      font-size: 12px;
      min-height: 40px;
      display:flex;
      align-items:center;
      white-space: pre-wrap;
    }
    .ok{ color: var(--ok); }
    .err{ color: var(--err); }

    .log{
      margin-top: 10px;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(0,0,0,.02);
      font-size: 12px;
      color: var(--text);
      line-height: 1.45;
      max-height: 220px;
      overflow: auto;
      white-space: pre-wrap;
    }
    .log .muted{ color: var(--muted); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">카카오페이지 URL → 노션 저장</div>
    <div class="sub">
      작품 URL을 <b>여러 줄</b>로 붙여넣고 <b>한 번에 저장</b>할 수 있어요.<br/>
      (빈 줄/중복 URL은 자동 무시)
    </div>

    <label for="contentUrls">카카오페이지 작품 URL (줄바꿈으로 여러 개)</label>
    <textarea id="contentUrls" placeholder="예:
https://page.kakao.com/content/65171279
https://page.kakao.com/content/12345678"></textarea>

    <div class="btns">
      <button class="primary" id="saveBtn">노션에 저장</button>
      <button id="openFirstBtn">첫 번째 URL 열기</button>
      <button id="clearBtn">입력 지우기</button>
    </div>

    <div class="hint">
      작품 URL 예시: <code>https://page.kakao.com/content/65171279</code><br/>
      서버는 저장 시 작품 메타(제목/표지/소개)도 시도하고, 막히면 URL 기반으로 저장돼요.
    </div>

    <div class="toast" id="toast">URL을 붙여넣고 “노션에 저장”을 눌러 보세요.</div>
    <div class="log" id="log"><span class="muted">로그가 여기에 표시돼요.</span></div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function setToast(text, cls=""){
      const el = $("toast");
      el.className = "toast " + cls;
      el.textContent = text || "";
    }

    function appendLog(line){
      const el = $("log");
      if (el.textContent.includes("로그가 여기에 표시돼요.")) el.textContent = "";
      el.textContent += (el.textContent ? "\n" : "") + line;
      el.scrollTop = el.scrollHeight;
    }

    function openInNewTab(url){
      window.open(url, "_blank", "noopener,noreferrer");
    }

    function normalizeUrls(raw){
      const lines = String(raw || "").split(/\r?\n/).map(s => s.trim()).filter(Boolean);

      // 중복 제거(순서 유지)
      const seen = new Set();
      const unique = [];
      for (const u of lines){
        if (seen.has(u)) continue;
        seen.add(u);
        unique.push(u);
      }

      // URL 형식 검증(형식만)
      const valid = [];
      const invalid = [];
      for (const u of unique){
        try {
          const parsed = new URL(u);
          // 카카오페이지 content만 느슨하게 체크(원하면 더 엄격하게 가능)
          if (!/page\.kakao\.com$/i.test(parsed.hostname)){
            invalid.push(u);
            continue;
          }
          valid.push(u);
        } catch {
          invalid.push(u);
        }
      }
      return { valid, invalid };
    }

    async function postJson(path, payload){
      const r = await fetch(path, {
        method: "POST",
        headers: { "content-type":"application/json" },
        body: JSON.stringify(payload)
      });
      const text = await r.text();
      let data;
      try { data = JSON.parse(text); }
      catch { data = { ok:false, error:"Non-JSON response", detail:text.slice(0,200) }; }
      return { status: r.status, data };
    }

    function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }

    $("openFirstBtn").addEventListener("click", () => {
      const { valid } = normalizeUrls($("contentUrls").value);
      if (!valid.length) return setToast("먼저 작품 URL을 1개 이상 넣어 주세요.", "err");
      openInNewTab(valid[0]);
      setToast("첫 번째 URL을 새 탭으로 열었어요.");
    });

    $("clearBtn").addEventListener("click", () => {
      $("contentUrls").value = "";
      $("log").textContent = "로그가 여기에 표시돼요.";
      setToast("입력을 지웠어요.");
    });

    $("saveBtn").addEventListener("click", async () => {
      const raw = $("contentUrls").value;
      const { valid, invalid } = normalizeUrls(raw);

      if (!valid.length){
        return setToast("저장할 URL이 없어요. 줄바꿈으로 URL을 붙여넣어 주세요.", "err");
      }

      // UI 잠금
      $("saveBtn").disabled = true;
      $("openFirstBtn").disabled = true;
      $("clearBtn").disabled = true;

      $("log").textContent = "";
      if (invalid.length){
        appendLog(`⚠️ 형식이 올바르지 않거나 허용되지 않은 URL ${invalid.length}개는 제외했어요:`);
        for (const u of invalid) appendLog(`  - ${u}`);
        appendLog("");
      }

      setToast(`저장 시작: ${valid.length}개`, "");
      appendLog(`✅ 저장 시작 (${valid.length}개)`);

      let okCount = 0;
      let failCount = 0;

      // 너무 빠르게 연속 요청하면 막힐 수 있어서, 짧게 텀을 둡니다.
      const GAP_MS = 250;

      for (let i = 0; i < valid.length; i++){
        const url = valid[i];
        setToast(`저장 중… (${i+1}/${valid.length})`, "");
        appendLog(`⏳ (${i+1}/${valid.length}) 저장 요청: ${url}`);

        try {
          const res = await postJson("/api/notion-create", { platform: "카카오페이지", url });

          if (res.data && res.data.ok){
            okCount++;
            const dbg = res.data.debug
              ? ` (upstream: ${res.data.debug.upstreamStatus}${res.data.debug.redirectedTo ? ", redirected" : ""})`
              : "";
            appendLog(`✅ 완료: ${url}${dbg}`);
          } else {
            failCount++;
            appendLog(`❌ 실패: ${url} — ${res.data?.error || "unknown"}`);
          }
        } catch (e){
          failCount++;
          appendLog(`❌ 실패: ${url} — ${String(e?.message || e)}`);
        }

        await sleep(GAP_MS);
      }

      if (failCount === 0){
        setToast(`저장 완료! ${okCount}/${valid.length}개 성공`, "ok");
      } else if (okCount === 0){
        setToast(`저장 실패… ${failCount}/${valid.length}개 실패`, "err");
      } else {
        setToast(`저장 완료 (성공 ${okCount}, 실패 ${failCount})`, "");
      }

      // UI 잠금 해제
      $("saveBtn").disabled = false;
      $("openFirstBtn").disabled = false;
      $("clearBtn").disabled = false;
    });
  </script>
</body>
</html>
